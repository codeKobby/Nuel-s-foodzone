rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isManager() {
      return request.auth.token.role == 'manager';
    }
    
    function isCashier() {
      return request.auth.token.role == 'cashier';
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // Allow managers to do anything
    match /{document=**} {
      allow read, write: if isManager();
    }
    
    // Cashier Rules
    match /menuItems/{item} {
      allow read: if isCashier();
    }
    
    match /orders/{orderId} {
      allow create: if isCashier();
      allow read, update: if isCashier();
    }
    
    match /miscExpenses/{expenseId} {
      allow create: if isCashier();
      allow read, update, delete: if isCashier() && resource.data.settled == false;
    }
    
    match /reconciliationReports/{reportId} {
        allow read, create: if isCashier();
    }
    
    // Read-only for core data
    match /credentials/{role} {
        allow read: if isAuthenticated();
    }

    match /counters/{counterId} {
        allow read: if isAuthenticated();
    }
    
    // Cashier accounts can be read by cashiers (for login) but only created/managed by managers
    match /cashierAccounts/{accountId} {
        allow read: if isCashier();
    }
  }
}

    