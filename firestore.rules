rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles from a custom claim
    function isManager() {
      return request.auth.token.role == 'manager';
    }

    function isCashier() {
      return request.auth.token.role == 'cashier';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    // Default deny all access unless explicitly allowed
    match /{document=**} {
      allow read, write: if false;
    }

    // Manager can read/write everything
    match /{document=**} {
      allow read, write: if isManager();
    }
    
    // Cashier specific rules
    
    // Cashiers can read menu items
    match /menuItems/{item} {
      allow read: if isCashier();
    }

    // Cashiers can create and update orders, but not delete
    match /orders/{orderId} {
      allow read, create, update: if isCashier();
    }
    
    // Cashiers can create and read their own expenses
    match /miscExpenses/{expenseId} {
      allow read, create: if isCashier();
    }

    // Cashiers can create and read their own reports
    match /reconciliationReports/{reportId} {
      allow read, create: if isCashier();
    }

    // Counter can be read by anyone signed in, but only written by backend/manager
    match /counters/{counterId} {
        allow read: if isSignedIn();
        allow write: if isManager();
    }

    // Cashiers cannot access cashier accounts or credentials directly
    match /cashierAccounts/{accountId} {
        allow read: if isManager();
    }
    match /credentials/{role} {
        allow read: if isManager();
    }
  }
}
