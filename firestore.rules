rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isManager() {
      // In a real app, you'd check a custom claim set during login.
      // For this app, we trust the 'role' passed from the client context.
      return request.auth.token.role == 'manager';
    }

    function isCashier() {
      return request.auth.token.role == 'cashier';
    }

    // --- Default Security ---
    // By default, nobody can read or write to any document.
    match /{document=**} {
      allow read, write: if false;
    }

    // --- Menu Items ---
    // Any authenticated user (cashier or manager) can read the menu.
    // Only managers can change the menu.
    match /menuItems/{item} {
      allow read: if isSignedIn();
      allow write: if isManager();
    }
    
    // --- Orders ---
    // Any authenticated user can create an order.
    // Managers can read all orders for the dashboard.
    // Cashiers can read and update orders (for pending, completion, payment).
    match /orders/{orderId} {
      allow read, update: if isSignedIn();
      allow create: if isSignedIn();
      allow delete: if isCashier();
    }

    // --- Miscellaneous Expenses ---
    // Cashiers can create expenses. Managers can read/update them (to settle).
    match /miscExpenses/{expenseId} {
      allow read, update: if isSignedIn();
      allow create: if isCashier();
      allow delete: if isCashier();
    }

    // --- Reconciliation Reports ---
    // Cashiers can create daily reports. Managers can read all reports.
    match /reconciliationReports/{reportId} {
      allow read: if isManager();
      allow create: if isCashier();
    }
    
    // --- Counters (for Order IDs) ---
    // Any authenticated user needs to be able to read and write to this document
    // inside a transaction to generate a new order ID.
    match /counters/orderIdCounter {
        allow read, write: if isSignedIn();
    }
    
    // --- Credentials & Accounts ---
    // Only managers should be able to manage credentials and cashier accounts.
    match /credentials/{role} {
        allow read, write: if isManager();
    }
    
    match /cashierAccounts/{accountId} {
        allow read, write: if isManager();
    }
  }
}
